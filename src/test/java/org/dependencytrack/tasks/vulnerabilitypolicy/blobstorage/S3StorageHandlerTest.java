package org.dependencytrack.tasks.vulnerabilitypolicy.blobstorage;


import io.minio.MakeBucketArgs;
import io.minio.PutObjectArgs;
import io.minio.errors.ErrorResponseException;
import io.minio.errors.InsufficientDataException;
import io.minio.errors.InternalException;
import io.minio.errors.InvalidResponseException;
import io.minio.errors.ServerException;
import io.minio.errors.XmlParserException;
import org.dependencytrack.PersistenceCapableTest;
import org.dependencytrack.tasks.vulnerabilitypolicy.S3Client;
import org.junit.After;
import org.junit.Before;
import org.junit.Rule;
import org.junit.Test;
import org.junit.contrib.java.lang.system.EnvironmentVariables;
import org.junit.jupiter.api.Assertions;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.security.InvalidKeyException;
import java.security.NoSuchAlgorithmException;
import java.util.ArrayList;
import java.util.zip.ZipEntry;
import java.util.zip.ZipInputStream;

public class S3StorageHandlerTest extends PersistenceCapableTest {


    private static final String ACCESS_KEY = "MINIO_ACCESS_KEY";
    private static final String SECRET_KEY = "MINIO_SECRET_KEY";
    MinioContainer minioContainer;
    S3StorageHandler s3StorageHandler;

    @Rule
    public EnvironmentVariables environmentVariables = new EnvironmentVariables();

    @Before
    public void beforeTest() {
        minioContainer = new MinioContainer(
                new MinioContainer.CredentialsProvider(ACCESS_KEY, SECRET_KEY));
        minioContainer.start();

    }

    @After
    public void afterTest() {
        environmentVariables.clear("VULNERABILITY_POLICY_ANALYSIS_ENABLED",
                "VULNERABILITY_POLICY_FETCH_SOURCE_NAME", "VULNERABILITY_POLICY_FETCH_URL",
                "VULNERABILITY_POLICY_S3_FILE_NAME", "VULNERABILITY_POLICY_S3_ACCESS_KEY",
                "VULNERABILITY_POLICY_S3_SECRET_KEY", "VULNERABILITY_POLICY_S3_BUCKET_NAME");
    }

    @Test
    public void testVerifyDownloadNeededBucketDoesNotExist() throws IOException, ServerException, InsufficientDataException,
            ErrorResponseException, NoSuchAlgorithmException, InvalidKeyException, InvalidResponseException,
            XmlParserException, InternalException {
        environmentVariables.set("VULNERABILITY_POLICY_ANALYSIS_ENABLED", "true");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_SOURCE_NAME", "s3");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_URL", "http://" + minioContainer.getHostAddress());
        environmentVariables.set("VULNERABILITY_POLICY_S3_FILE_NAME", "test.zip");
        environmentVariables.set("VULNERABILITY_POLICY_S3_ACCESS_KEY", "MINIO_ACCESS_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_SECRET_KEY", "MINIO_SECRET_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_BUCKET_NAME", "testbucket");
        S3Client s3Client = new S3Client();
        s3StorageHandler = new S3StorageHandler(s3Client);
        Assertions.assertFalse(s3StorageHandler.verifyDownloadNeeded());
    }

    @Test
    public void testVerifyDownloadNeededBucketExist() throws IOException, ServerException, InsufficientDataException,
            ErrorResponseException, NoSuchAlgorithmException, InvalidKeyException, InvalidResponseException,
            XmlParserException, InternalException {
        environmentVariables.set("VULNERABILITY_POLICY_ANALYSIS_ENABLED", "true");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_SOURCE_NAME", "s3");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_URL", "http://" + minioContainer.getHostAddress());
        environmentVariables.set("VULNERABILITY_POLICY_S3_FILE_NAME", "test.zip");
        environmentVariables.set("VULNERABILITY_POLICY_S3_ACCESS_KEY", "MINIO_ACCESS_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_SECRET_KEY", "MINIO_SECRET_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_BUCKET_NAME", "testbucket");
        S3Client s3Client = new S3Client();
        Path path = Paths.get("src/test/resources/unit/tasks/vulnerabilitypolicy/test.zip");
        byte[] arr = Files.readAllBytes(path);
        s3Client.getMinioClient().makeBucket(MakeBucketArgs.builder().bucket("testbucket").build());
        s3Client.getMinioClient().putObject(PutObjectArgs.builder().bucket("testbucket").
                object("test.zip").stream(new ByteArrayInputStream(arr), -1, 10485760).build());
        s3StorageHandler = new S3StorageHandler(s3Client);
        Assertions.assertTrue(s3StorageHandler.verifyDownloadNeeded());
    }

    @Test
    public void testDownload() throws IOException, ServerException, InsufficientDataException,
            ErrorResponseException, NoSuchAlgorithmException, InvalidKeyException, InvalidResponseException,
            XmlParserException, InternalException {
        environmentVariables.set("VULNERABILITY_POLICY_ANALYSIS_ENABLED", "true");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_SOURCE_NAME", "s3");
        environmentVariables.set("VULNERABILITY_POLICY_FETCH_URL", "http://" + minioContainer.getHostAddress());
        environmentVariables.set("VULNERABILITY_POLICY_S3_FILE_NAME", "test.zip");
        environmentVariables.set("VULNERABILITY_POLICY_S3_ACCESS_KEY", "MINIO_ACCESS_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_SECRET_KEY", "MINIO_SECRET_KEY");
        environmentVariables.set("VULNERABILITY_POLICY_S3_BUCKET_NAME", "testbucket");
        S3Client s3Client = new S3Client();
        Path path = Paths.get("src/test/resources/unit/tasks/vulnerabilitypolicy/test.zip");
        byte[] arr = Files.readAllBytes(path);
        s3Client.getMinioClient().makeBucket(MakeBucketArgs.builder().bucket("testbucket").build());
        s3Client.getMinioClient().putObject(PutObjectArgs.builder().bucket("testbucket").
                object("test.zip").stream(new ByteArrayInputStream(arr), -1, 10485760).build());
        s3StorageHandler = new S3StorageHandler(s3Client);
        ArrayList<ZipEntry> zipEntries;
        try (ZipInputStream zipInputStream = s3StorageHandler.downloadZippedContent()) {
            ZipEntry zipEntry = zipInputStream.getNextEntry();
            zipEntries = new ArrayList<>();
            while (zipEntry != null) {
                if (!(zipEntry.getName().startsWith(".") || zipEntry.getName().startsWith("_")) && (zipEntry.getName().contains(".yaml") || zipEntry.getName().contains(".yml"))) {
                    zipEntries.add(zipEntry);
                }
                zipEntry = zipInputStream.getNextEntry();
            }
        }
        Assertions.assertTrue(zipEntries.size() > 0);
        Assertions.assertEquals("test/sample 2.yaml", zipEntries.get(0).getName());
    }
}
