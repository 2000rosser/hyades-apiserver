package org.dependencytrack.persistence;

import org.cyclonedx.model.vulnerability.Vulnerability;
import org.dependencytrack.AbstractPostgresEnabledTest;
import org.dependencytrack.model.AnalysisJustification;
import org.dependencytrack.model.AnalysisState;
import org.dependencytrack.model.VulnerabilityPolicy;
import org.dependencytrack.model.vulnerabilitypolicy.VulnerabilityPolicyAnalysis;
import org.junit.Test;

import java.util.Date;
import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.junit.Assert.assertNotNull;

public class VulnerabilityPolicyQueryManagerTest extends AbstractPostgresEnabledTest {
    @Test
    public void testVulnerabilityPolicyIsCreated() {

        VulnerabilityPolicy vulnPolicy = getVulnerabilityPolicyInstance();

        int count = qm.createVulnerabilityPolicy(vulnPolicy);

        assertThat(count).isEqualTo(1);
        List<VulnerabilityPolicy> vulnerabilityPolicies = qm.getAllVulnerabilityPolicies();
        assertNotNull(vulnerabilityPolicies);
        assertThat(vulnerabilityPolicies).hasSize(1);
        assertThat(vulnerabilityPolicies).satisfiesExactlyInAnyOrder(
                vulnerabilityPolicy -> {
                    assertThat(vulnerabilityPolicy).isNotNull();
                    assertThat(vulnerabilityPolicy.getCreated()).isNotNull();
                    assertThat(vulnerabilityPolicy.getConditions()).isEqualTo(vulnPolicy.getConditions());
                    assertThat(vulnerabilityPolicy.getAnalysis()).isNotNull();
                    assertThat(vulnerabilityPolicy.getAnalysis().state().name()).isEqualTo(AnalysisState.NOT_AFFECTED.name());
                    assertThat(vulnerabilityPolicy.getAnalysis().suppress()).isEqualTo(true);
                    assertThat(vulnerabilityPolicy.getAnalysis().justification().name()).isEqualTo(AnalysisJustification.CODE_NOT_REACHABLE.name());
                    assertThat(vulnerabilityPolicy.getAnalysis().details()).isEqualTo("something");
                    assertThat(vulnerabilityPolicy.getRatings()).isNotNull();
                    assertThat(vulnerabilityPolicy.getRatings()).hasSize(1);
                    assertThat(vulnerabilityPolicy.getRatings()).satisfiesExactlyInAnyOrder(
                            rating1 -> {
                                assertThat(rating1.getScore()).isEqualTo(6.3);
                                assertThat(rating1.getMethod().getMethodName()).isEqualTo(Vulnerability.Rating.Method.CVSSV3.getMethodName());
                                assertThat(rating1.getSeverity().getSeverityName()).isEqualTo(Vulnerability.Rating.Severity.HIGH.getSeverityName());
                                assertThat(rating1.getVector()).isEqualTo("CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L");
                            });
                });
    }

    @Test
    public void testVulnerabilityPolicyIsDeleted() {
        VulnerabilityPolicy vulnPolicy = getVulnerabilityPolicyInstance();
        int count = qm.createVulnerabilityPolicy(vulnPolicy);
        assertThat(count).isEqualTo(1);
        qm.deleteVulnerabilityPolicyByName(vulnPolicy.getName());
        List<VulnerabilityPolicy> policies = qm.getAllVulnerabilityPolicies();
        assertThat(policies).hasSize(0);
    }

    @Test
    public void testVulnerabilityPolicyIsUpdated() {

        VulnerabilityPolicy vulnPolicy = getVulnerabilityPolicyInstance();

        int count = qm.createVulnerabilityPolicy(vulnPolicy);
        assertThat(count).isEqualTo(1);

        String[] updatedConditions = new String[]{"foo=something", "bar=baz", "c=woah"};
        vulnPolicy.setConditions(updatedConditions);
        qm.updateVulnerablePolicyByName(vulnPolicy);

        VulnerabilityPolicy vulnerabilityPolicy = qm.getVulnerabilityPolicyByName(vulnPolicy.getName());
        assertNotNull(vulnerabilityPolicy);
        assertThat(vulnerabilityPolicy.getCreated()).isNotNull();
        assertThat(vulnerabilityPolicy.getConditions()).isEqualTo(updatedConditions);
        assertThat(vulnerabilityPolicy.getAnalysis()).isNotNull();
        assertThat(vulnerabilityPolicy.getAnalysis().state().name()).isEqualTo(AnalysisState.NOT_AFFECTED.name());
        assertThat(vulnerabilityPolicy.getAnalysis().suppress()).isEqualTo(true);
        assertThat(vulnerabilityPolicy.getAnalysis().justification().name()).isEqualTo(AnalysisJustification.CODE_NOT_REACHABLE.name());
        assertThat(vulnerabilityPolicy.getAnalysis().details()).isEqualTo("something");
        assertThat(vulnerabilityPolicy.getRatings()).isNotNull();
        assertThat(vulnerabilityPolicy.getRatings()).hasSize(1);
        assertThat(vulnerabilityPolicy.getRatings()).satisfiesExactlyInAnyOrder(
                rating1 -> {
                    assertThat(rating1.getScore()).isEqualTo(6.3);
                    assertThat(rating1.getMethod().getMethodName()).isEqualTo(Vulnerability.Rating.Method.CVSSV3.getMethodName());
                    assertThat(rating1.getSeverity().getSeverityName()).isEqualTo(Vulnerability.Rating.Severity.HIGH.getSeverityName());
                    assertThat(rating1.getVector()).isEqualTo("CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L");
                });

    }

    private static VulnerabilityPolicy getVulnerabilityPolicyInstance() {
        VulnerabilityPolicy vulnPolicy = new VulnerabilityPolicy();
        vulnPolicy.setCreated(new Date());
        vulnPolicy.setConditions(new String[]{"vuln.id == \"CVE-123\" || vuln.aliases.exists(alias, alias.id == \"CVE-123\")",
                "component.name == \"foo\" && project.name == \"bar\" && \"internal\" in project.tags && !component.is_dependency_of(org.dependencytrack.policy.v1.Component{group: \"org.springframework.boot\"}"});
        vulnPolicy.setName("name");
        VulnerabilityPolicyAnalysis vulnerabilityPolicyAnalysis = new VulnerabilityPolicyAnalysis(
                AnalysisState.NOT_AFFECTED, AnalysisJustification.CODE_NOT_REACHABLE, "something", true);
        vulnPolicy.setAnalysis(vulnerabilityPolicyAnalysis);
        Vulnerability.Rating rating = new Vulnerability.Rating();
        rating.setSeverity(Vulnerability.Rating.Severity.HIGH);
        rating.setMethod(Vulnerability.Rating.Method.CVSSV3);
        rating.setScore(6.3);
        rating.setVector("CVSS:3.0/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:L");
        vulnPolicy.setRatings(List.of(rating));
        return vulnPolicy;
    }
}
